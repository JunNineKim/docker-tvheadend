#!/usr/bin/with-contenv bash

# check if EPG2XML_VER exist
if [[ -z "${EPG2XML_VER}" ]]; then
	echo "ERROR: EPG2XML_VER undefined"
	exit 0
fi

if [ "${EPG2XML_VER}" == "latest" ]; then
	TAG_NAME=$(curl -s https://api.github.com/repos/wonipapa/epg2xml/releases/latest | jq -r ".tag_name")
else
	TAG_NAME="v${EPG2XML_VER}"
fi

DOWNLOAD_URL="https://api.github.com/repos/wonipapa/epg2xml/tarball/${TAG_NAME}"

echo "Installing epg2xml ${TAG_NAME}"

# make folder
[[ ! -d "/epg2xml" ]] && mkdir /epg2xml

# download epg2xml
if [[ `wget -S --spider "${DOWNLOAD_URL}" 2>&1 | grep 'HTTP/1.1 200 OK'` ]]; then
	wget -q "${DOWNLOAD_URL}" -P /tmp
else
	echo "ERROR: Invalid download url for epg2xml"
	echo "ERROR: ${DOWNLOAD_URL}"
	exit 0
fi

# update epg2xml main scripts
cd /tmp && \
	tar -xzf "${TAG_NAME}" --strip 1 && \
	mv /tmp/*.php /epg2xml/

# update Channel.json
if [[ ! -f /epg2xml/Channel.json ]] || [[ ! -z "${UPDATE_CHANNEL}" ]]; then
	mv /tmp/Channel.json /epg2xml/
	echo "Channel.json updated"
fi

# also update epg2xml.json files if not exist
[[ ! -f /epg2xml/epg2xml.json ]] && \
	mv /tmp/epg2xml.json /epg2xml/ && \
	echo "epg2xml.json updated"

# permissions
chown -R abc:abc \
	/epg2xml

# cleanup
rm -rf /tmp/*
